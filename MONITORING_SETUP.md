# å£°çº¹è¯†åˆ«APIç›‘æ§ç³»ç»Ÿ

## æ¦‚è¿°

ä¸ºäº†è¯Šæ–­APIè¿æ¥å¤±è´¥é—®é¢˜ï¼Œå·²åœ¨ `/home/pi/workspace/speaker/server.py` ä¸­æ·»åŠ äº†å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿã€‚

## æ–°å¢åŠŸèƒ½

### 1. è¯¦ç»†æ—¥å¿—è®°å½•

**æ—¥å¿—æ–‡ä»¶ä½ç½®**: `logs/speaker_api_YYYYMMDD.log`

- æ¯å¤©è‡ªåŠ¨åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
- è®°å½•æ‰€æœ‰è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ—¶é—´æˆ³ã€æ–‡ä»¶åã€è¡Œå·ã€è¯¦ç»†é”™è¯¯ï¼‰
- æ§åˆ¶å°åŒæ—¶è¾“å‡ºç®€åŒ–æ—¥å¿—

**æ—¥å¿—ç¤ºä¾‹**:
```
2025-10-07 10:15:23 - INFO - âœ… /verify - 2.134s - IP: 192.168.1.100
2025-10-07 10:15:25 - INFO - âŒ /verify - 0.045s - IP: 192.168.1.100 - Error: Audio1: Audio too short: 0.3s (min: 0.5s)
```

### 2. è¯·æ±‚ç›‘æ§ç»Ÿè®¡

**`RequestMonitor` ç±»** è‡ªåŠ¨è·Ÿè¸ªä»¥ä¸‹æŒ‡æ ‡ï¼š

- **æ€»è¯·æ±‚æ•°** (`total_requests`)
- **æˆåŠŸæ¬¡æ•°** (`success_count`)
- **å¤±è´¥æ¬¡æ•°** (`error_count`)
- **æˆåŠŸç‡** (`success_rate`)
- **å¹³å‡å“åº”æ—¶é—´** (`avg_response_time`)
- **æœ€è¿‘100æ¡è¯·æ±‚å†å²** (åŒ…å«æ—¶é—´æˆ³ã€endpointã€æˆåŠŸçŠ¶æ€ã€å“åº”æ—¶é—´ã€é”™è¯¯ä¿¡æ¯ã€å®¢æˆ·ç«¯IP)

**è‡ªåŠ¨ç»Ÿè®¡æ‰“å°**: æ¯10ä¸ªè¯·æ±‚æ‰“å°ä¸€æ¬¡ç»Ÿè®¡æ‘˜è¦
```
============================================================
ğŸ“Š APIç»Ÿè®¡ - æ€»è¯·æ±‚: 20
   æˆåŠŸ: 18 | å¤±è´¥: 2 | æˆåŠŸç‡: 90.0%
   å¹³å‡å“åº”æ—¶é—´: 1.856s
============================================================
```

### 3. å¢å¼ºçš„ `/health` ç«¯ç‚¹

ç°åœ¨ `/health` ç«¯ç‚¹è¿”å›å®Œæ•´çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```bash
curl http://tenyuan.tech:7001/health
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "model_loaded": true,
  "model_id": "iic/speech_eres2net_sv_zh-cn_16k-common",
  "device": "cpu",
  "timestamp": 1728282123.456,
  "uptime": 3600.5,
  "statistics": {
    "total_requests": 20,
    "success_count": 18,
    "error_count": 2,
    "success_rate": "90.00%",
    "avg_response_time": "1.856s",
    "recent_requests": [
      {
        "timestamp": 1728282100.123,
        "endpoint": "/verify",
        "success": true,
        "duration": 2.134,
        "error": null,
        "client_ip": "192.168.1.100"
      },
      // ... æœ€è¿‘10æ¡
    ]
  }
}
```

### 4. ç›‘æ§çš„ `/verify` ç«¯ç‚¹

ç°åœ¨æ¯ä¸ª `/verify` è¯·æ±‚éƒ½ä¼šï¼š

1. **è®°å½•å®¢æˆ·ç«¯IP** - å¯ä»¥è¯†åˆ«å“ªäº›å®¢æˆ·ç«¯é‡åˆ°é—®é¢˜
2. **è®°å½•è¯·æ±‚æ—¶é•¿** - åŒ…å«å®Œæ•´è¯·æ±‚å¤„ç†æ—¶é—´ï¼ˆä¸ä»…æ˜¯æ¨ç†æ—¶é—´ï¼‰
3. **è®°å½•æˆåŠŸ/å¤±è´¥çŠ¶æ€** - è‡ªåŠ¨åˆ†ç±»è¯·æ±‚ç»“æœ
4. **è®°å½•é”™è¯¯ä¿¡æ¯** - å¤±è´¥æ—¶è®°å½•å…·ä½“é”™è¯¯åŸå› 
5. **å†™å…¥æ—¥å¿—æ–‡ä»¶** - æ‰€æœ‰ä¿¡æ¯æŒä¹…åŒ–åˆ°æ—¥å¿—æ–‡ä»¶

## ä½¿ç”¨æ–¹æ³•

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh pi@tenyuan.tech

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/pi/workspace/speaker

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/speaker_api_$(date +%Y%m%d).log

# æˆ–è€…æŸ¥çœ‹æœ€è¿‘100è¡Œ
tail -n 100 logs/speaker_api_$(date +%Y%m%d).log
```

### æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```bash
# é€šè¿‡å¥åº·æ£€æŸ¥ç«¯ç‚¹
curl http://tenyuan.tech:7001/health | jq '.statistics'

# æˆ–è€…ä½¿ç”¨ Python å®¢æˆ·ç«¯
python3 << EOF
import requests
response = requests.get('http://tenyuan.tech:7001/health')
stats = response.json()['statistics']
print(f"æ€»è¯·æ±‚: {stats['total_requests']}")
print(f"æˆåŠŸç‡: {stats['success_rate']}")
print(f"å¹³å‡å“åº”: {stats['avg_response_time']}")
EOF
```

### åˆ†æå¤±è´¥è¯·æ±‚

```bash
# æŸ¥æ‰¾æ‰€æœ‰å¤±è´¥çš„è¯·æ±‚
grep "âŒ" logs/speaker_api_$(date +%Y%m%d).log

# æŸ¥æ‰¾ç‰¹å®šIPçš„è¯·æ±‚
grep "192.168.1.100" logs/speaker_api_$(date +%Y%m%d).log

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep "Error:" logs/speaker_api_$(date +%Y%m%d).log | cut -d':' -f4- | sort | uniq -c
```

## é‡å¯æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹

```bash
cd /home/pi/workspace/speaker

# åœæ­¢å½“å‰æœåŠ¡
./stop_production.sh

# å¯åŠ¨æ–°æœåŠ¡ï¼ˆåº”ç”¨ç›‘æ§åŠŸèƒ½ï¼‰
./start_production.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://tenyuan.tech:7001/health
```

## è¯Šæ–­é—®é¢˜æµç¨‹

### 1. æ£€æŸ¥æ•´ä½“å¥åº·çŠ¶æ€
```bash
curl http://tenyuan.tech:7001/health
```
- æŸ¥çœ‹ `status` æ˜¯å¦ä¸º "healthy"
- æŸ¥çœ‹ `success_rate` æˆåŠŸç‡
- æŸ¥çœ‹ `avg_response_time` å¹³å‡å“åº”æ—¶é—´

### 2. ç›‘æ§å®æ—¶æ—¥å¿—
```bash
tail -f logs/speaker_api_$(date +%Y%m%d).log
```
åœ¨å®¢æˆ·ç«¯ï¼ˆxiaoyu-serverï¼‰è§¦å‘å‡ æ¬¡è¯­éŸ³è¯†åˆ«ï¼Œè§‚å¯Ÿï¼š
- æ˜¯å¦æ”¶åˆ°è¯·æ±‚ï¼Ÿ
- è¯·æ±‚çš„å“åº”æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ
- æ˜¯å¦æœ‰é”™è¯¯ï¼Ÿé”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ

### 3. åˆ†æå¤±è´¥æ¨¡å¼
```bash
# æŸ¥çœ‹æœ€è¿‘çš„å¤±è´¥
grep "âŒ" logs/speaker_api_$(date +%Y%m%d).log | tail -20

# æŒ‰å®¢æˆ·ç«¯IPåˆ†ç»„
grep "âŒ" logs/speaker_api_$(date +%Y%m%d).log | awk '{print $NF}' | sort | uniq -c
```

### 4. æ£€æŸ¥å®¢æˆ·ç«¯é‡è¯•æ˜¯å¦ç”Ÿæ•ˆ

åœ¨å®¢æˆ·ç«¯æ—¥å¿—ä¸­æŸ¥æ‰¾ï¼š
- `âš ï¸ APIè°ƒç”¨å¤±è´¥ (å°è¯• 1/3)ï¼Œ0.5ç§’åé‡è¯•...` - è¡¨ç¤ºé‡è¯•æœºåˆ¶å·¥ä½œ
- `âŒ APIè°ƒç”¨å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°` - è¡¨ç¤ºè¿ç»­3æ¬¡éƒ½å¤±è´¥

å¦‚æœæœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤º**æ”¶åˆ°**è¯·æ±‚ä½†å®¢æˆ·ç«¯æŠ¥å‘Š**è¿æ¥å¤±è´¥**ï¼Œè¯´æ˜é—®é¢˜åœ¨ç½‘ç»œå±‚ï¼ˆè¶…æ—¶ã€ä¸¢åŒ…ç­‰ï¼‰ã€‚

å¦‚æœæœåŠ¡å™¨æ—¥å¿—**æ²¡æœ‰**è¯·æ±‚è®°å½•è€Œå®¢æˆ·ç«¯æŠ¥å‘Š**è¿æ¥å¤±è´¥**ï¼Œè¯´æ˜è¯·æ±‚æ ¹æœ¬æ²¡åˆ°è¾¾æœåŠ¡å™¨ï¼ˆç½‘ç»œä¸­æ–­ã€é˜²ç«å¢™ç­‰ï¼‰ã€‚

## é¢„æœŸè¯Šæ–­ç»“æœ

### åœºæ™¯1: æœåŠ¡å™¨è¿‡è½½
- æ—¥å¿—æ˜¾ç¤ºå¤§é‡è¯·æ±‚
- å¹³å‡å“åº”æ—¶é—´å¾ˆé•¿ï¼ˆ>5ç§’ï¼‰
- æˆåŠŸç‡é™ä½
- **è§£å†³**: å¢åŠ  worker æ•°é‡æˆ–å‡çº§æœåŠ¡å™¨

### åœºæ™¯2: ç½‘ç»œä¸ç¨³å®š
- æ—¥å¿—æ˜¾ç¤ºéƒ¨åˆ†æ—¶æ®µæ²¡æœ‰è¯·æ±‚
- å®¢æˆ·ç«¯æŠ¥å‘Šè¿æ¥å¤±è´¥ä½†æœåŠ¡å™¨æ²¡æœ‰æ—¥å¿—
- **è§£å†³**: æ£€æŸ¥ç½‘ç»œè·¯ç”±ã€é˜²ç«å¢™ã€ä»£ç†è®¾ç½®

### åœºæ™¯3: å®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®è¿‡çŸ­
- æ—¥å¿—æ˜¾ç¤ºè¯·æ±‚æˆåŠŸä½†è€—æ—¶è¾ƒé•¿
- å®¢æˆ·ç«¯æŠ¥å‘Šè¶…æ—¶
- **è§£å†³**: å¢åŠ å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´ï¼ˆvoice_verify.py çš„ timeout å‚æ•°ï¼‰

### åœºæ™¯4: éŸ³é¢‘æ–‡ä»¶é—®é¢˜
- æ—¥å¿—æ˜¾ç¤º "Audio too short" æˆ– "Invalid audio file" é”™è¯¯
- **è§£å†³**: æ£€æŸ¥éŸ³é¢‘å½•åˆ¶è´¨é‡å’Œæ—¶é•¿

## ç›¸å…³æ–‡ä»¶

- **æœåŠ¡å™¨ä»£ç **: `/home/pi/workspace/speaker/server.py`
- **æ—¥å¿—ç›®å½•**: `/home/pi/workspace/speaker/logs/`
- **å¯åŠ¨è„šæœ¬**: `/home/pi/workspace/speaker/start_production.sh`
- **åœæ­¢è„šæœ¬**: `/home/pi/workspace/speaker/stop_production.sh`
- **å®¢æˆ·ç«¯ä»£ç **: `/home/pi/workspace/xiaoyu-server/voice_verify.py`

## ç›‘æ§ä»£ç ä½ç½®

### RequestMonitor ç±»å®šä¹‰
`server.py` è¡Œ 56-126

### /verify ç«¯ç‚¹ç›‘æ§
`server.py` è¡Œ 270-380

### /health ç«¯ç‚¹ç»Ÿè®¡
`server.py` è¡Œ 248-268

## ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ  Prometheus metrics** - ç”¨äºé•¿æœŸç›‘æ§å’Œå¯è§†åŒ–
2. **é‚®ä»¶/é’‰é’‰å‘Šè­¦** - æˆåŠŸç‡ä½äº90%æ—¶è‡ªåŠ¨å‘Šè­¦
3. **è¯·æ±‚æ—¥å¿—æ•°æ®åº“** - å°†è¯·æ±‚å†å²å­˜å…¥æ•°æ®åº“ä¾¿äºæŸ¥è¯¢åˆ†æ
4. **æ…¢è¯·æ±‚åˆ†æ** - å•ç‹¬è®°å½•å“åº”æ—¶é—´>3ç§’çš„è¯·æ±‚
5. **IPé»‘åå•** - è‡ªåŠ¨å±è”½å¼‚å¸¸IP
